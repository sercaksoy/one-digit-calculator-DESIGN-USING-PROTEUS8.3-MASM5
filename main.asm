;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Cmt Kas 14 2020
; Processor: 8086
; Compiler:  MASM32
;
; Before starting simulation set Internal Memory Size 
; in the 8086 model properties to 0x10000
;====================================================================
STAK    SEGMENT PARA STACK 'STACK'
        DW 20 DUP(?)
STAK    ENDS

DATA    SEGMENT PARA 'DATA'
MSG_A	DB 00H,33H,30H,0FFH,33H,30H,0FCH,30H		; SIRAYLA O,N,A,Y,H,A,T,A HARFLERININ A PORT LEDLERI
MSG_B	DB 0FFH,0EEH,77H,0DAH,77H,77H,0DDH,77H		; SIRAYLA O,N,A,Y,H,A,T,A HARFLERININ B PORT LEDLERI
VALUES  DB 00H,00H,00H,01H,01H,02H,03H,02H,04H,05H,06H,03H,07H,08H,09H,04H ; KEYPAD'DEN SÜRÜLECEK DEGERLER
DATA    ENDS

CODE    SEGMENT PARA 'CODE'
        ASSUME CS:CODE, DS:DATA, SS:STAK
	DELAY PROC NEAR	
	PUSH CX
	MOV CX, 05FFFh
	COUNT:
	LOOP COUNT
	POP CX
	RET
	DELAY ENDP

START:
      MOV AX, DATA
      MOV DS, AX
      MOV AL, 09H ; PC4 = 1
      MOV DX, 206H ; Control Word'den erisim
      OUT DX, AL 
      MOV AL, 05H ; PC2 = 1
      OUT DX, AL
      MOV AL, 0BCH  ; MOD 1, A PORT INPUT AND B PORT OUTPUT 
      OUT DX, AL  ; TO FIRST 8255
      MOV CX,3
ARITHMETIC:		; BU LABEL KULLANICIDAN ISTENILEN SAYIDA TUS ALINMASINI KONTROL EDIYOR
INPUT_TRIGGER:MOV DX,204H  ; 8255 INPUT ICIN IZIN BEKLIYOR
      IN AL,DX
      AND AL,08H	; 0000 1000 MASK
      CMP AL,00H
      JE INPUT_TRIGGER  ; INPUT ICIN IZIN BEKLENIYOR
	 
      MOV DX,200H
      IN AL,DX
      AND AL,0FH
      MOV BL,AL
      XOR BH,BH
      MOV AL,VALUES[BX]
      XOR AH,AH
      PUSH AX		; ALINAN ILK DEGERI SAKLIYORUZ
	
      CMP CX,2		; SEMBOLLERIN 0 OLARAK BASTIRILMASI GEREKIYOR
      JZ SYMBOL_Z
	
      CMP CX,1		; IKINCI SAYININ BASTIRILMAMASI GEREKIYOR
      JZ SYMBOL
	
OUTPUT_TRIGGER:
      MOV DX,204H
      IN AL,DX
      AND AL,01H
      CMP AL,00H
      JE OUTPUT_TRIGGER ; OUTPUT ICIN HAZIR OLUNDUGUNDA AKTARILIYOR
	
      MOV AL,VALUES[BX]
      MOV DX, 202H
      OUT DX, AL
	
      LOOP ARITHMETIC	; 3 SURUM BOYU ISLEMLER DEVAM EDIYOR
	
SYMBOL_Z:MOV DX,204H
      IN AL,DX
      AND AL,01H
      CMP AL,00H
      JE SYMBOL_Z
	
      XOR AL,AL   ; ICINI SIFIRLIYORUZ
      MOV DX,202H
      OUT DX,AL

      LOOP ARITHMETIC
	
SYMBOL:
      POP DX
      POP AX
      CMP AL,1	; TOPLAMA ISARETI 1 OLARAK KODLANDI
      JZ TOPLA
      CMP AL,2	; ÇIKARTMA ISARETI 2 OLARAK KODLANDI
      JZ CIKART
      CMP AL,3	; ÇARPMA ISARETI 3 OLARAK KODLANDI
      JZ CARP
      CMP AL,4	; BOLME ISARETI 4 OLARAK KODLANDI
      JZ BOL
TOPLA:
      POP BX
      ADD BX,DX
      CMP BL,9	; UC NOKTALARI ELIYORUZ
      JA HATA_YAKALA
      
      JMP PRINT_VALUE
CIKART:
      POP BX
      CMP BX,DX	; UC NOKTALARI ELIYORUZ
      JB HATA_YAKALA
      
      SUB BX,DX      
      JMP PRINT_VALUE
CARP:
      POP BX
      MOV AL,DL
      MUL BL
      CMP AX,9 ; UC NOKTALARI ELIYORUZ
      JA HATA_YAKALA
      
      MOV BX,AX
      
      JMP PRINT_VALUE
BOL:     
      CMP DX,0 ; UC NOKTALARI ELIYORUZ
      JZ HATA_YAKALA
      
      MOV BX,DX
      POP AX
      
      CMP AX,BX ; UC NOKTALARI ELIYORUZ
      JA HATA_YAKALA
      
      DIV BL
      CMP AH, 00H ; UC NOKTALARI ELIYORUZ
      JNZ HATA_YAKALA
      
      MOV BX,AX
      JMP PRINT_VALUE  
      
HATA_YAKALA:
      MOV BL,0FFH
      
PRINT_VALUE:
      MOV DX,204H
      IN AL,DX
      AND AL,01H
      CMP AL,00H
      JE PRINT_VALUE
      
      MOV AL,BL
      MOV DX,202H
      OUT DX,AL
      
      MOV AL,80H 
      OUT 66H,AL
      
      CMP BL,9
      JA PRINT_HATA
      
PRINT_ONAY:    ; DIZININ BASLAYACAGI YERI ONAYA GORE BELIRLIYORUZ
      MOV BX,0
      MOV CX,4
      JMP PRINT_LOOP
      
PRINT_HATA:	; DIZININ BASLAYACAGI YERI HATAYA GORE BELIRLIYORUZ
      MOV BX,4
      MOV CX,4 
PRINT_LOOP:		; DAHA ONCE KODLANAN DEGERLERI SIRASIYLA BASTIRIYORUZ
      MOV AL, MSG_A[BX]
      OUT 60H,AL
      MOV AL, MSG_B[BX]
      OUT 62H,AL
      INC BX
      CALL DELAY
      LOOP PRINT_LOOP     
           
CODE    ENDS
        END START